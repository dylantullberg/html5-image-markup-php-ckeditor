var generateUUID=function(){var d=new Date().getTime();var uuid='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=(d+Math.random()*16)%16|0;d=Math.floor(d/16);return(c=='x'?r:(r&0x7|0x8)).toString(16);});return uuid;};(function($){var defaults={color:'red',width:4,opacity:.5,current_tool:'pen'};$.fn.imageMarkup=function(options){var settings=$.extend({},defaults,options||{});var self=this;window.current_image_markup=self;self.current_tool=settings.current_tool;this.setOptions=function(options){settings=$.extend(settings,options);};this.removeLastPath=function(){if(self.paths.length>0){localStorage.clear();paper.projects[0].clear();self.paths.pop();savePaths();self.paths=[];renderPaths();}};window.onkeydown=function(e){return!(e.keyCode==32);};window.onload=function(){setTimeout(function(){$(self).each(function(eachIndex,eachItem){self.paths=[];var img=eachItem;var canvas=$('<canvas>').attr({width:$(img).width(),height:$(img).height()}).addClass('image-markup-canvas').css({position:'absolute',top:$(img).position().top,left:$(img).position().left});$(img).after(canvas);$(img).data('paths',[]);paper.setup(canvas[0]);$(canvas).mouseenter(function(){paper.projects[eachIndex].activate();});var tool=new paper.Tool();var offsetX=0;var offsetY=0;tool.onMouseMove=function(event){if(!$('.context-menu-list').is(':visible')){position=[offsetX,offsetY];paper.project.activeLayer.selected=false;if((self.current_tool=="select"||self.current_tool=="erase")&&event.item){event.item.selected=true;selectedItem=event.item;}else{selectedItem=null;}}};tool.onMouseDown=function(event){switch(event.event.button){case 0:if(path){path.selected=false;}if(self.current_tool=="pen"){path=new paper.Path();path.data.id=generateUUID();path.strokeColor=settings.color;path.strokeWidth=settings.width;path.opacity=settings.opacity;}else if(self.current_tool=="ellipse"){path=new paper.Path.Ellipse({center:event.point,radius:[0,0]});path.strokeColor=settings.color;path.strokeWidth=settings.width;path.opacity=settings.opacity;}else if(self.current_tool=="rectangle"){path=new paper.Path.Rectangle(event.point,event.point);path.strokeColor=settings.color;path.strokeWidth=settings.width;path.opacity=settings.opacity;}else if(self.current_tool=="line"){path=new paper.Path();path.data.id=generateUUID();path.strokeColor=settings.color;path.strokeWidth=settings.width;path.opacity=settings.opacity;path.add(event.point);}else if(self.current_tool=="arrow"){path=new paper.Path();path.data.id=generateUUID();path.strokeColor=settings.color;path.strokeWidth=settings.width;path.opacity=settings.opacity;path.add(event.point);}break;case 2:break;}};tool.onMouseDrag=function(event){switch(event.event.button){case 0:if(selectedItem){if(self.current_tool=="select"){if(!mouseDownPoint)mouseDownPoint=selectedItem.position;selectedItem.position=new paper.Point(selectedItem.position.x+event.delta.x,selectedItem.position.y+event.delta.y);}}else{if(self.current_tool=="pen"){if(path){path.add(event.point);}}else if(self.current_tool=="ellipse"){if(path){path.remove();}path=new paper.Path.Rectangle(event.downPoint,event.point);path.strokeColor=settings.color;path.strokeWidth=1;path.strokeCap='round';path.opacity=settings.opacity;path.dashArray=[10,4];}else if(self.current_tool=="rectangle"){if(path){path.remove();}path=new paper.Path.Rectangle(event.downPoint,event.point);path.strokeColor=settings.color;path.strokeWidth=settings.width;path.opacity=settings.opacity;}else if(self.current_tool=="line"){if(path){if(!path.segments[1]){path.add(event.point);}else{path.segments[1].point=event.point;}}}else if(self.current_tool=="arrow"){if(path){if(!path.segments[1]){path.add(event.point);}else{path.segments[1].point=event.point;}}}}break;case 2:break;}};tool.onMouseUp=function(event){switch(event.event.button){case 0:if(selectedItem){if(self.current_tool=="select"){if(mouseDownPoint){var selectedItemId=selectedItem.id;var draggingStartPoint={x:mouseDownPoint.x,y:mouseDownPoint.y};CommandManager.execute({execute:function(){},unexecute:function(){$(paper.project.activeLayer.children).each(function(index,item){if(item.id==selectedItemId){if(item.segments){var middlePoint=new paper.Point(((item.segments[item.segments.length-1].point.x)-item.segments[0].point.x)/2,((item.segments[item.segments.length-1].point.y)-item.segments[0].point.y)/2);item.position=new paper.Point(draggingStartPoint.x,draggingStartPoint.y);}else{item.position=draggingStartPoint;}return false;}});}});mouseDownPoint=null;}}else if(self.current_tool=="erase"){self.erase(selectedItem);}}else{if(self.current_tool=="pen"){path.simplify();path.remove();var strPath=path.exportJSON({asString:true});var uid=generateUUID();CommandManager.execute({execute:function(){path=new paper.Path();path.importJSON(strPath);path.data.uid=uid;},unexecute:function(){$(paper.project.activeLayer.children).each(function(index,item){if(item.data&&item.data.uid){if(item.data.uid==uid){item.remove();}}});}});}else if(self.current_tool=="ellipse"){if(path){path.remove();}path=new paper.Path.Ellipse({center:event.middlePoint,radius:[Math.abs(event.delta.x/2),Math.abs(event.delta.y/2)]});path.strokeColor=settings.color;path.strokeWidth=settings.width;path.opacity=settings.opacity;path.data.id=generateUUID();path.remove();var strPath=path.exportJSON({asString:true});var uid=generateUUID();CommandManager.execute({execute:function(){path=new paper.Path();path.importJSON(strPath);path.data.uid=uid;},unexecute:function(){$(paper.project.activeLayer.children).each(function(index,item){if(item.data&&item.data.uid){if(item.data.uid==uid){item.remove();}}});}});}else if(self.current_tool=="rectangle"){if(path){path.remove();}path=new paper.Path.Rectangle(event.downPoint,event.point);path.strokeColor=settings.color;path.strokeWidth=settings.width;path.opacity=settings.opacity;path.data.id=generateUUID();path.remove();var strPath=path.exportJSON({asString:true});var uid=generateUUID();CommandManager.execute({execute:function(){path=new paper.Path();path.importJSON(strPath);path.data.uid=uid;},unexecute:function(){$(paper.project.activeLayer.children).each(function(index,item){if(item.data&&item.data.uid){if(item.data.uid==uid){item.remove();}}});}});}else if(self.current_tool=="line"){if(!path.segments[1]){path.segments[1].point=event.point;}else{path.add(event.point);}path.remove();var strPath=path.exportJSON({asString:true});var uid=generateUUID();CommandManager.execute({execute:function(){path=new paper.Path();path.importJSON(strPath);path.data.uid=uid;},unexecute:function(){$(paper.project.activeLayer.children).each(function(index,item){if(item.data&&item.data.uid){if(item.data.uid==uid){item.remove();}}});}});}else if(self.current_tool=="arrow"){if(!path.segments[1]){path.segments[1].point=event.point;}else{path.add(event.point);}var line_start=new paper.Point(path.segments[0].point);var line_end=new paper.Point(path.segments[1].point);var arrow_start=new paper.Point(event.delta);arrow_start.x=arrow_start.x/7;arrow_start.y=arrow_start.y/7;var first_end=new paper.Point();first_end.x=line_end.x+arrow_start.rotate(135).x;first_end.y=line_end.y+arrow_start.rotate(135).y;var second_end=new paper.Point();second_end.x=line_end.x+arrow_start.rotate(-135).x;second_end.y=line_end.y+arrow_start.rotate(-135).y;var arrow=new paper.Path([first_end,line_end,second_end]);arrow.data.id=path.data.id;arrow.strokeWidth=settings.width;arrow.strokeColor=settings.color;var complete_arrow=new paper.Group({children:[path,arrow]});complete_arrow.strokeWidth=settings.width;complete_arrow.strokeColor=settings.color;complete_arrow.opacity=settings.opacity;complete_arrow.data.id=path.data.id;complete_arrow.remove();var strPath=complete_arrow.exportJSON({asString:true});var uid=generateUUID();CommandManager.execute({execute:function(){path=new paper.Group();path.importJSON(strPath);path.data.uid=uid;},unexecute:function(){$(paper.project.activeLayer.children).each(function(index,item){if(item.data&&item.data.uid){if(item.data.uid==uid){item.remove();}}});}});}}break;case 2:contextPoint=event.point;contextSelectedItemId=selectedItem?selectedItem.data.id:'';break;}};tool.onKeyUp=function(event){if(selectedItem){if(selectedItem.content){if(event.key=='backspace')selectedItem.content=selectedItem.content.slice(0,-1);else{selectedItem.content=selectedItem.content.replace('<some text>','');if(event.key=='space'){selectedItem.content+=' ';}else if(event.key.length==1){selectedItem.content+=event.key;}}}}};paper.view.draw();});},200);};var path;var position;var contextPoint;var contextSelectedItemId;var selectedItem;var mouseDownPoint;this.erase=function(element){if(element&&element.data.id){var clone_element=null;$(paper.project.activeLayer.children).each(function(index,item){if(element.data.id==item.data.id){clone_element=item.exportJSON({asString:true});}});CommandManager.execute({execute:function(){$(paper.project.activeLayer.children).each(function(index,item){if(element.data.id==item.data.id){item.remove();}});},unexecute:function(){path=new paper.Path();path.importJSON(clone_element);}});}paper.view.draw();};this.erase_all=function(){var all_elements=new Array();$(paper.project.activeLayer.children).each(function(index,item){var clone_element=item.exportJSON({asString:true});all_elements.push(clone_element);});CommandManager.execute({execute:function(){$(paper.project.activeLayer.children).each(function(index,item){item.remove();});},unexecute:function(){$(all_elements).each(function(index,element){path=new paper.Path();path.importJSON(element);});}});paper.view.draw();};this.downloadCanvas=function(canvas,filename){var lnk=document.createElement('a'),e;lnk.download=filename;try{lnk.href=canvas.toDataURL();if(document.createEvent){e=document.createEvent("MouseEvents");e.initMouseEvent("click",true,true,window,0,0,0,0,0,false,false,false,false,0,null);lnk.dispatchEvent(e);}else if(lnk.fireEvent){lnk.fireEvent("onclick");}}catch(error){alert("Sorry, it was not possible download the image!");}};this.download=function(){var canvas=paper.project.activeLayer.view.element;var img=$(canvas).parent().find('img')[0];var mergeCanvas=$('<canvas>').attr({width:$(img).width(),height:$(img).height()});var mergedContext=mergeCanvas[0].getContext('2d');mergedContext.clearRect(0,0,$(img).width(),$(img).height());mergedContext.drawImage(img,0,0);mergedContext.drawImage(canvas,0,0);self.downloadCanvas(mergeCanvas[0],"my_edited_image.png");};this.custom_downloadCanvas=function(canvas,success_function){var result=null;try{var dataURL=canvas.toDataURL("image/png");$.ajax({type:"POST",url:"php/upload.php",async:true,dataType:"json",data:{img_base64:dataURL},beforeSend:function(){$('#img-editable').css('border',"none");$("#img-container").hide();$("#img-saving").show();},complete:function(){is_locked=false;$("#img-saving").hide();$("#img-loading").show();success_function(result);},success:function(data){result=data;},error:function(xhr,status,error){result={"error":"An unexpected error occurred on the server. Please try later!"};}});}catch(error){is_locked=false;success_function(result);}};this.custom_download=function(success_function){is_locked=true;var canvas=paper.project.activeLayer.view.element;var img=$(canvas).parent().find('img')[0];var mergeCanvas=$('<canvas>').attr({width:$(img).width(),height:$(img).height()});var mergedContext=mergeCanvas[0].getContext('2d');mergedContext.clearRect(0,0,$(img).width(),$(img).height());mergedContext.drawImage(img,0,0);mergedContext.drawImage(canvas,0,0);self.custom_downloadCanvas(mergeCanvas[0],success_function);};this.setText=function(){var uid=generateUUID();var pos={x:0,y:30};CommandManager.execute({execute:function(){var TXT_DBL_CLICK='[ Edit me ]';var txt=TXT_DBL_CLICK;var text=new paper.PointText(pos);text.content=txt;text.fillColor=settings.color;text.fontSize=18;text.fontFamily='Verdana';text.data.uid=uid;text.data.id=uid;text.opacity=settings.opacity;text.onDoubleClick=function(event){if(this.className=='PointText'){var txt=prompt("Type in your text",this.content.replace(TXT_DBL_CLICK,''));if(txt&&txt.length>0)this.content=txt;}};},unexecute:function(){$(paper.project.activeLayer.children).each(function(index,item){if(item.data&&item.data.uid){if(item.data.uid==uid){item.remove();}}});}});};this.setSelectIcon=function(){$('.image-markup-canvas').css('cursor',"url(img/layer-select.png) 12 12, auto");};this.setPenColor=function(color){self.setOptions({color:color});$('.image-markup-canvas').css('cursor',"url(img/layer-pen.png) 2 23, auto");};this.setPenIcon=function(){$('.image-markup-canvas').css('cursor',"url(img/layer-pen.png) 2 23, auto");};this.setArrowIcon=function(){$('.image-markup-canvas').css('cursor',"url(img/layer-arrow2.png) 2 23, auto");};this.setEraserIcon=function(){$('.image-markup-canvas').css('cursor',"url(img/layer-eraser.png) 2 23, auto");};this.setCursorHandOpen=function(){$('.image-markup-canvas').css('cursor',"url(img/hand-open.png) 25 25, auto");};this.setCursorHandClose=function(){$('.image-markup-canvas').css('cursor',"url(img/hand-close.png) 25 25, auto");};return self;};}(jQuery));