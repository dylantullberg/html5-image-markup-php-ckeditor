CKEDITOR.dialog.add('img_editor_dialog',function(editor){return{title:'Image Editor',resizable:CKEDITOR.DIALOG_RESIZE_NONE,minWidth:700,minHeight:400,width:700,height:400,contents:[{id:"preview",label:"Image Editor",elements:[{type:"html",id:"previewHtml",html:'<iframe src="'+editor.img_editor_path+"dialogs/ImageMarkup/editor.html"+'" style="width: 100%; height: 400px" hidefocus="true" frameborder="0" '+'id="cke_lba_img_editor_iframe"></iframe>'}]}],onShow:function(){if(typeof(lba_initiated)==='undefined'){lba_initiated=false;}var selection=editor.getSelection();var element=selection.getStartElement();if(element)element=element.getAscendant('img',true);if(!element||element.getName()!='img'){CKEDITOR.dialog.getCurrent().hide();alert("First you must select an image!");CKEDITOR.config.img_editor_current_img=null;}else{this.element=element;CKEDITOR.config.img_editor_current_img=this.element.$;if(!lba_initiated){lba_initiated=true;}else{document.getElementById('cke_lba_img_editor_iframe').contentWindow.location.reload();}}},buttons:[{id:'img_editor_save_replace',type:'button',label:'Save and Replace',title:'Save the edited image and replaces the original',accessKey:'C',disabled:false,onClick:function(){var dialog=CKEDITOR.dialog.getCurrent();var save_button=this;save_button.disable();var img=CKEDITOR.config.img_editor_current_img;uploadCompleted=function(result){var error_txt="";if(result){if(result['new_img_url']&&!result['error']){img.src=result['new_img_url'];}else if(result['error']){error_txt=result['error'];}else{error_txt="Sorry, it was not possible save the image!";}}else{error_txt="Sorry, it was not possible save the image!";}if(error_txt!==""){alert(error_txt);}save_button.enable();dialog.hide();};downloadCustomImg(uploadCompleted);}},CKEDITOR.dialog.cancelButton]};});